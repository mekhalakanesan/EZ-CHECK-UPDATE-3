<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EPILEPSY EZ CHECK | JKWPKL&P</title>

<!-- Tailwind CSS & Inter Font -->

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<!-- FIREBASE IMPORTS -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- CONFIGURATION SECTION ---

// 1. FOR GITHUB HOSTING: Paste your Firebase Config object inside the brackets below.
const GITHUB_FIREBASE_CONFIG = {}; // USER MUST PASTE CONFIG HERE IF NOT USING CANVAS

// 2. LOGIC: Use Environment config (if in AI preview) OR User config (if on GitHub)
const envConfig = typeof __firebase_config !== &#39;undefined&#39; ? JSON.parse(__firebase_config) : {};
const finalConfig = Object.keys(envConfig).length &gt; 0 ? envConfig : GITHUB_FIREBASE_CONFIG;

// 3. INITIALIZE
if (Object.keys(finalConfig).length &gt; 0 &amp;&amp; finalConfig.projectId) {
  window.app = initializeApp(finalConfig);
  window.db = getFirestore(window.app);
  console.log(&quot;Firebase initialized successfully.&quot;);
} else {
  console.warn(&quot;Firebase configuration missing. &#39;Visits&#39; counter will not work on GitHub unless you edit the GITHUB_FIREBASE_CONFIG section in the code.&quot;);
  window.db = null;
}


</script>

<style>
body {
font-family: 'Inter', sans-serif;
background-color: #f7f9fb;
}

/* --- NATIVE TOGGLE STYLING (Robust &amp; Clickable) --- */
/* Hide the actual checkbox input */
.toggle-checkbox {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

/* The Label becomes the clickable row. 
   When the input (sibling) is checked, we style the children of the label */
.toggle-checkbox:checked + label .switch-bg {
    background-color: #10b981; /* Green-500 */
}
.toggle-checkbox:checked + label .switch-dot {
    transform: translateX(100%);
}

/* Default Switch State */
.switch-bg {
    transition: background-color 0.2s ease-in-out;
    background-color: #e5e7eb; /* Gray-200 */
}
.switch-dot {
    transition: transform 0.2s ease-in-out;
    transform: translateX(0);
}

/* Inputs */
.input-field {
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem;
    text-align: right;
    font-weight: 700;
    color: #1e3a8a; /* Indigo-800 */
    background: transparent;
    width: 100%;
    outline: none;
}
.input-wrapper {
    transition: ring 0.2s;
}
.input-wrapper:focus-within {
    ring: 2px;
    ring-color: #6366f1; /* Indigo-500 */
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center; align-items: center;
    z-index: 50;
    backdrop-filter: blur(2px);
}
.modal-content {
    background: white;
    padding: 1.5rem;
    border-radius: 1rem;
    width: 90%; max-width: 600px; max-height: 90vh;
    overflow-y: auto;
    animation: scaleUp 0.2s ease-out;
}
@keyframes scaleUp {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Disabled States */
.disabled-area {
    opacity: 0.5;
    pointer-events: none;
    filter: grayscale(100%);
}
/* Force Links to remain clickable and visible */
.link-button {
    color: #000000 !important; /* PITCH BLACK */
    cursor: pointer !important; 
    opacity: 1 !important; /* Force full visibility */
    pointer-events: all !important; /* Ensure it&#39;s clickable */
}


</style>

</head>
<body class="p-4 sm:p-8">
<div id="app" class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mb-10">

<!-- Header -->
<header class="p-6 bg-indigo-700 text-white relative overflow-hidden">
  <div class="relative z-10">
    <h1 class="text-2xl font-extrabold text-center tracking-tight">EPILEPSY EZ CHECK</h1>
    <p class="text-sm text-center mt-1 text-indigo-100 font-medium">
        TDM Indication Score Calculator
    </p>
    <p class="text-xs text-center mt-1 opacity-60 tracking-widest">
        JKWPKL&P
    </p>
  </div>
  <!-- Decorative circle -->
  <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-600 rounded-full opacity-50"></div>
</header>

<!-- DISCLAIMER -->
<div class="p-4 mx-6 mt-6 rounded-lg">
    <p class="text-xs italic text-gray-500 text-center">
        This tool is meant to support, not replace, clinical judgment.
    </p>
</div>

<!-- Inputs & Toggles Section -->
<main class="p-6 space-y-6">
    
  <!-- SEIZURE HISTORY (Gatekeeper) -->
  <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-2 flex items-center gap-2">
      SEIZURE HISTORY
  </h2>
  <div id="seizure-history-gate" class="space-y-3 p-3 border border-gray-200 rounded-xl bg-white shadow-sm">
    
    <!-- 1. Has breakthrough seizures? -->
    <div class="relative w-full">
        <input type="checkbox" id="check-seizure" class="toggle-checkbox" onchange="calculateScore()">
        <label for="check-seizure" class="flex justify-between items-center w-full cursor-pointer select-none">
            <span class="text-sm font-medium text-gray-700">1. Has breakthrough seizures?</span>
            <div class="relative w-12 h-6 rounded-full switch-bg">
                <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
            </div>
        </label>
    </div>

    <!-- 2. Last breakthrough seizure < 6 months? -->
    <div class="relative w-full border-t border-gray-100 pt-3">
        <input type="checkbox" id="check-6months" class="toggle-checkbox" onchange="calculateScore()">
        <label for="check-6months" class="flex justify-between items-center w-full cursor-pointer select-none">
            <span class="text-sm font-medium text-gray-700">2. Seizure &lt; 6 months ago?</span>
            <div class="relative w-12 h-6 rounded-full switch-bg">
                <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
            </div>
        </label>
    </div>
    
    <p class="text-xs italic text-gray-400 pt-1 text-center">Both must be YES to enable TDM scoring.</p>
  </div>
  
  <!-- CALCULATOR CORE (Will be visually disabled if Gate Fails) -->
  <div id="calculator-core" class="transition-opacity duration-300">
      
      <!-- 1. Demographic Inputs -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6">1. Demographics & BMI</h2>

      <div class="grid grid-cols-2 gap-4">
        <!-- Age Input -->
        <div class="input-group">
          <label for="input-age" class="block text-xs font-bold uppercase text-gray-500 mb-1">Age</label>
          <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
            <input type="number" id="input-age" min="0" max="150" placeholder="0" class="input-field" oninput="calculateScore()">
            <span class="mr-3 text-gray-400 font-medium text-xs">yr</span>
          </div>
        </div>

        <!-- Weight Input -->
        <div class="input-group">
          <label for="input-weight" class="block text-xs font-bold uppercase text-gray-500 mb-1">Weight</label>
          <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
            <input type="number" id="input-weight" min="1" step="0.1" placeholder="0.0" class="input-field" oninput="calculateScore()">
            <span class="mr-3 text-gray-400 font-medium text-xs">kg</span>
          </div>
        </div>
        
        <!-- Height Input -->
        <div class="input-group">
          <label for="input-height" class="block text-xs font-bold uppercase text-gray-500 mb-1">Height</label>
          <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
            <input type="number" id="input-height" min="0.1" step="0.01" placeholder="0.00" class="input-field" oninput="calculateScore()">
            <span class="mr-3 text-gray-400 font-medium text-xs">m</span>
          </div>
        </div>
      </div>

      <!-- Calculated BMI Display -->
      <div class="mt-4 p-4 rounded-xl text-center bg-indigo-50 border border-indigo-200 shadow-sm">
          <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest">BMI (kg/m¬≤)</p>
          <p id="calculated-bmi" class="text-3xl font-black text-gray-300 mt-1">--</p>
          <p id="bmi-status" class="text-xs font-bold mt-1 text-gray-400 h-4"></p>
      </div>

      <!-- 2. Comorbidities -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6">2. Comorbidities</h2>
      <div id="comorbidity-toggles" class="space-y-3">
        
        <!-- Renal -->
        <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-renal" class="toggle-checkbox" onchange="handleToggleChange('renal')">
            <label for="check-renal" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700">Renal Failure</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>

        <!-- Liver -->
        <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-liver" class="toggle-checkbox" onchange="handleToggleChange('liver')">
            <label for="check-liver" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700">Liver Failure</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>

        <!-- DM (Data only) -->
        <div class="relative w-full bg-gray-50 border border-gray-200 rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-dm" class="toggle-checkbox" onchange="handleToggleChange('dm')">
            <label for="check-dm" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-500">Diabetes Mellitus</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>

        <!-- HTN (Data only) -->
        <div class="relative w-full bg-gray-50 border border-gray-200 rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-htn" class="toggle-checkbox" onchange="handleToggleChange('htn')">
            <label for="check-htn" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-500">Hypertension</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>
      </div>
      
      <!-- 3. Special Population -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4">3. Special Population</h2>
      <div id="special-population-check" class="space-y-3">
        
        <!-- Children -->
        <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50" id="age-child-pop-box">
            <div class="flex justify-between items-center">
                <p class="text-sm font-medium text-gray-700">Children (&lt;20 yr)</p>
                <p id="age-child-pop-status" class="text-xs font-black text-gray-400">NOT MET</p>
            </div>
        </div>

        <!-- Elderly -->
        <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50" id="age-geriatric-pop-box">
            <div class="flex justify-between items-center">
                <p class="text-sm font-medium text-gray-700">Elderly (&ge;65 yr)</p>
                <p id="age-geriatric-pop-status" class="text-xs font-black text-gray-400">NOT MET</p>
            </div>
        </div>

        <!-- Pregnant -->
        <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-pregnancy" class="toggle-checkbox" onchange="handleToggleChange('pregnancy')">
            <label for="check-pregnancy" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700">Pregnant</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>

        <!-- Surgery -->
        <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
            <input type="checkbox" id="check-surgery" class="toggle-checkbox" onchange="handleToggleChange('surgery')">
            <label for="check-surgery" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700 w-3/4">Post-Major Surgery (&lt;3mo)</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>
      </div>


      <!-- 4. Clinical Factors -->
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4">4. Clinical Factors</h2>
      
      <div id="clinical-toggles" class="space-y-3">
        <!-- Dynamic Injection -->
      </div>

      <!-- GEMINI FEATURE: Counseling Generator Button -->
      <button id="open-chatbot-btn" onclick="openChatModal()" class="w-full mt-6 py-3 px-4 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>üí¨ Chat with Epilepsy Reference AI</span>
      </button>
  </div> <!-- END CALCULATOR CORE -->
</main>

<!-- Score Summary (Sticky Footer) -->
<footer id="score-footer" class="p-6 bg-gray-50 border-t border-gray-200">
  <div class="text-center">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Positive Criteria</p>
    <div id="final-score" class="text-6xl font-black text-gray-300 mt-1 transition-colors duration-300">
      0
    </div>
  </div>
  
  <div id="indication-box" class="mt-4 p-4 rounded-xl text-center shadow-lg transition-all duration-300 bg-gray-200 text-gray-500">
    <p class="text-xs font-bold uppercase tracking-wider mb-1">Status</p>
    <p id="indication-text" class="text-xl font-extrabold">NO INDICATION</p>
  </div>

  <!-- VISITS & COPYRIGHT -->
  <div class="flex justify-between items-end text-xs text-gray-400 mt-6 border-t pt-4">
      <div>
        <p id="visits-display" class="font-mono text-indigo-400">Visits: ...</p>
      </div>
      <div class="text-right">
          <p>&copy; JKWPKL&P 2025</p>
          <p class="text-[10px] opacity-70">v2.1 Stable</p>
      </div>
  </div>
</footer>

<!-- MODAL OVERLAY - DRUG CHECKERS -->
<div id="drug-checker-modal" class="modal-overlay" onclick="closeModal(event, 'drug-checker-modal')">
    <div class="modal-content shadow-2xl">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Drug Checker</h3>
            <button onclick="document.getElementById('drug-checker-modal').style.display='none';" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">
                &times;
            </button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<!-- MODAL OVERLAY - GEMINI CHATBOT -->
<div id="epilepsy-chatbot-modal" class="modal-overlay" onclick="closeModal(event, 'epilepsy-chatbot-modal')">
    <div class="modal-content shadow-2xl max-w-lg">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-xl font-bold text-indigo-700">Epilepsy Reference Chatbot</h3>
            <button onclick="document.getElementById('epilepsy-chatbot-modal').style.display='none';" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">
                &times;
            </button>
        </div>
        
        <div id="chat-container" class="h-96 flex flex-col justify-between">
            <!-- Chat History -->
            <div id="chat-history" class="overflow-y-auto p-2 space-y-3 flex-1 mb-4 border rounded-lg bg-gray-50">
                <div class="text-sm text-gray-500 text-center p-2">
                    Ask me anything about Epilepsy Management or TDM using the linked Malaysian guidelines.
                </div>
            </div>

            <!-- Input Form -->
            <form id="chat-form" class="flex space-x-2" onsubmit="event.preventDefault(); handleChatQuery()">
                <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                <button type="submit" id="chat-send-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">
                    Send
                </button>
            </form>
        </div>

        <p class="text-xs text-red-500 mt-4 border-t pt-2">
            ‚ö†Ô∏è **Reference Disclaimer:** Answers are strictly based on the content of the Epilepsy Council Malaysia Consensus Guideline and the Clinical Pharmacokinetics Pharmacy Handbook (2nd Ed). Always verify with original documents.
        </p>
    </div>
</div>
<!-- END MODAL OVERLAY - GEMINI CHATBOT -->


</div>

<script type="module">
import { doc, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const db = window.db; 
const appId = typeof __app_id !== &#39;undefined&#39; ? __app_id : &#39;epilepsy-ez-check-app&#39;;
const apiKey = &quot;&quot;; // API Key placeholder for Gemini API calls
const GEMINI_MODEL = &#39;gemini-2.5-flash-preview-09-2025&#39;; 
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

// --- FIREBASE UTILIZATION TRACKING ---
async function trackUtilization() {
    if (!db) {
        document.getElementById(&#39;visits-display&#39;).textContent = &quot;Visits: (No DB)&quot;;
        return;
    }
    try {
        const statsPath = `artifacts/${appId}/public/data`;
        const docId = &#39;usage_stats&#39;;
        const visitsRef = doc(db, statsPath, docId);

        // 1. Increment
        await setDoc(visitsRef, { 
            epilepsy_tool_visits: increment(1),
            last_access: new Date().toISOString()
        }, { merge: true });

        // 2. Read back
        const docSnap = await getDoc(visitsRef);
        if (docSnap.exists()) {
            const count = docSnap.data().epilepsy_tool_visits || 1;
            document.getElementById(&#39;visits-display&#39;).textContent = `Visits: ${count.toLocaleString()}`;
        }
    } catch (error) {
        console.error(&quot;Tracking Error:&quot;, error);
        document.getElementById(&#39;visits-display&#39;).textContent = &quot;Visits: --&quot;;
    }
}

// --- DATA ---
const ASM_OPTIONS = [&quot;VALPROIC ACID&quot;, &quot;CARBAMAZEPINE&quot;, &quot;PHENYTOIN&quot;, &quot;PHENOBARBITONE&quot;];
const REFERENCE_CITATION = &quot;Clinical Pharmacokinetics Pharmacy Handbook. 2nd Edition.&quot;;

// Extracted content from the Clinical Pharmacokinetics Pharmacy Handbook (Minimized for demonstration/API limits)
const TDM_GUIDE_CONTENT = `
--- CLINICAL PHARMACOKINETICS PHARMACY HANDBOOK (2ND ED) ---
- CARBAMAZEPINE (CBZ): Therapeutic Range: 4-12 mg/L. Vd: 0.6-2 L/kg. Clearance: Auto-inducer (CYP3A4). Drug Interactions: Inhibitors (Clarithromycin, Diltiazem, Grapefruit juice) increase CBZ concentration. Inducers (Phenobarbital, Rifampicin) decrease CBZ concentration. ADR: Steven-Johnson syndrome, Toxic epidermal necrolysis.
- PHENYTOIN (PHT): Therapeutic Range: 10-20 mg/L. Metabolism: Nonlinear (Michaelis-Menten kinetics). High protein binding (90-95%). ADR: Far lateral nystagmus (&gt;20 mg/L), Ataxia (&gt;30 mg/L). Interactions: Fluoxetine, Isoniazid increase PHT. Carbamazepine, Valproic Acid decrease PHT.
- PHENOBARBITONE (PB): Therapeutic Range: 15-40 mg/L. Half-life: 96 hours (Adults). Clearance: 0.004 L/kg/hr (Adults). ADR: Sedation (&gt;5 mg/L), Impaired cognition (&gt;19 mg/L), Coma (&gt;=65 mg/L).
- VALPROIC ACID (VPA): Therapeutic Range: 50-100 mg/L. High protein binding (90-95%) and concentration-dependent. Clearance: Hepatic, 7-12 ml/kg/hr (Adult Mono). ADR: Hepatotoxicity, Pancreatitis, Thrombocytopenia, Hyperammonemic encephalopathy. Interactions: VPA increases concentrations of Lamotrigine, Phenobarbital. VPA decreased by Carbapenem, Carbamazepine.
- GENERAL PK: Neonates and Pediatrics often have higher Vd (hydrophilic drugs) and lower CL/different CYP activity than adults. Geriatrics often have decreased hepatic blood flow and decreased renal clearance.
--- END HANDBOOK CONTENT ---
`;

const ASM_ADR_TOXICITY = {
    &quot;VALPROIC ACID&quot;: {
        adr: &quot;Hepatotoxicity, Pancreatitis, Alopecia, Thrombocytopenia, Steven-Johnson syndrome, Hyperammonemic encephalopathy&quot;,
        toxicity: &quot;CNS depression such as lethargy, sedation, vomiting, tachycardia, hypotension and respiratory depression&quot;
    },
    &quot;CARBAMAZEPINE&quot;: {
        adr: &quot;Steven-Johnson syndrome, Toxic epidermal necrolysis, Agranulocytosis, Thrombocytopenia, Leukopenia, Pancytopenia, Hepatitis, Hepatotoxicity, Angioedema, Blurred vision, Nystagmus&quot;,
        toxicity: &quot;Drowsiness, slurred speech, ataxia, hallucination, nausea &amp; vomiting, hypotension, seizures, respiratory depression, coma&quot;
    }
    // ... (Remaining ASM data)
};

const ASM_INTERACTIONS = {
    // ... (Interaction data)
};

const CRITERIA_TOGGLES = [
  { id: &#39;2&#39;, text: &#39;Seizure occurs during sleep&#39; },
  { id: &#39;3&#39;, text: &#39;Any drug/dose changes (ASM only)&#39; },
  { id: &#39;4&#39;, text: &#39;Suspected subtherapeutic dose&#39; },
  { id: &#39;5&#39;, text: &#39;Suspected adverse effect / toxicity&#39;, link: &#39;toxicity&#39; },
  { id: &#39;6a&#39;, text: &#39;Changes in medication (Brand / Formulation)&#39; },
  { id: &#39;7&#39;, text: &#39;Poor compliance suspected&#39; },
  { id: &#39;8&#39;, text: &#39;Any suspected interaction&#39;, link: &#39;interaction&#39; },
];

// --- DOM Elements &amp; State Management ---
const getStorageKey = (id) =&gt; `epilepsy-ez-${id}`;
const loadState = (id) =&gt; localStorage.getItem(getStorageKey(id));
const saveState = (id, value) =&gt; localStorage.setItem(getStorageKey(id), value);

const checkSeizure = document.getElementById(&#39;check-seizure&#39;);
const check6Months = document.getElementById(&#39;check-6months&#39;);
// ... (rest of DOM elements) ...

// --- CHATBOT LOGIC ---

function displayMessage(sender, text) {
    const history = document.getElementById(&#39;chat-history&#39;);
    const isUser = sender === &#39;user&#39;;
    const msgClass = isUser ? &#39;text-right&#39; : &#39;text-left&#39;;
    const bubbleClass = isUser ? &#39;bg-indigo-500 text-white ml-auto&#39; : &#39;bg-white text-gray-800 mr-auto shadow&#39;;

    const messageDiv = document.createElement(&#39;div&#39;);
    messageDiv.className = msgClass;
    messageDiv.innerHTML = `&lt;span class=&quot;${bubbleClass} inline-block px-4 py-2 rounded-xl max-w-[80%] text-sm&quot;&gt;${text}&lt;/span&gt;`;
    history.appendChild(messageDiv);
    history.scrollTop = history.scrollHeight;
}

function openChatModal() {
    document.getElementById(&#39;epilepsy-chatbot-modal&#39;).style.display = &#39;flex&#39;;
    // Clear old messages except the initial instruction
    const history = document.getElementById(&#39;chat-history&#39;);
    if (history.children.length &gt; 1) {
        history.innerHTML = `&lt;div class=&quot;text-sm text-gray-500 text-center p-2&quot;&gt;Ask me anything about Epilepsy Management or TDM using the linked Malaysian guidelines.&lt;/div&gt;`;
    }
}

async function handleChatQuery() {
    const input = document.getElementById(&#39;chat-input&#39;);
    const query = input.value.trim();
    const sendBtn = document.getElementById(&#39;chat-send-btn&#39;);
    const history = document.getElementById(&#39;chat-history&#39;);

    if (!query) return;

    displayMessage(&#39;user&#39;, query);
    input.value = &#39;&#39;;
    sendBtn.disabled = true;

    const loadingId = &#39;loading-msg&#39;;
    displayMessage(&#39;ai&#39;, `&lt;div id=&quot;${loadingId}&quot; class=&quot;flex items-center justify-center space-x-1&quot;&gt;&lt;svg class=&quot;animate-spin h-4 w-4 text-indigo-500&quot; viewBox=&quot;0 0 24 24&quot;&gt;&lt;circle cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;10&quot; stroke=&quot;#a5b4fc&quot; stroke-width=&quot;4&quot;&gt;&lt;/circle&gt;&lt;path d=&quot;M12 2v4M12 18v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M3 12h4M17 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83&quot; stroke=&quot;#4f46e5&quot; stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span&gt;Thinking...&lt;/span&gt;&lt;/div&gt;`);
    
    try {
        const systemPrompt = `You are a Clinical Pharmacist Assistant. Your primary goal is to provide evidence-based information regarding epilepsy management and Therapeutic Drug Monitoring (TDM). 
        STRICTLY use the following two sources as your knowledge base, prioritizing the content of these specific documents:
        1. Epilepsy Council Malaysia Consensus Guideline (Use web search grounding for this document).
        2. Clinical Pharmacokinetics Pharmacy Handbook (Use the content provided below):
        --- START HANDBOOK CONTENT ---
        ${TDM_GUIDE_CONTENT}
        --- END HANDBOOK CONTENT ---
        
        Answer the user&#39;s question concisely and accurately, citing which guideline or drug section (e.g., [Handbook: Phenytoin] or [Guideline: Dosing]) the information comes from. Do not mention the URL.`;

        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ &quot;google_search&quot;: {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const response = await fetch(GEMINI_API_URL, {
            method: &#39;POST&#39;,
            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`API status: ${response.status}`);

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || &quot;I was unable to retrieve a relevant answer from the provided guidelines.&quot;;
        
        history.removeChild(document.getElementById(loadingId).closest(&#39;.text-left&#39;));
        displayMessage(&#39;ai&#39;, text);

    } catch (error) {
        console.error(&quot;Chatbot Error:&quot;, error);
        history.removeChild(document.getElementById(loadingId).closest(&#39;.text-left&#39;));
        displayMessage(&#39;ai&#39;, `I encountered a network or API error while looking up the guidelines. Please try again. (${error.message})`);
    } finally {
        sendBtn.disabled = false;
    }
}
// ... (rest of existing functions) ...

function closeModal(event, modalId) {
    const modalEl = document.getElementById(modalId);
    if (event.target === modalEl) {
        modalEl.style.display = &#39;none&#39;;
    }
}

// ... (All other existing functions like updateToxicityResults, checkInteraction, setCoreInputsDisabled, etc.) ...

// --- HTML RENDERER FOR DYNAMIC TOGGLES ---
function renderToggles() {
  clinicalTogglesEl.innerHTML = &#39;&#39;;
  
  CRITERIA_TOGGLES.forEach(item =&gt; {
    const key = item.id;
    const isChecked = loadState(key) === &#39;true&#39;;

    // Styling for the link if present (Pitch Black forced via CSS)
    const linkButtonHtml = item.link 
        ? `&lt;div class=&quot;mt-1&quot;&gt;&lt;button class=&quot;link-button text-xs font-bold text-indigo-600 hover:text-indigo-800 underline focus:outline-none&quot; onclick=&quot;openModal(&#39;${item.link}&#39;)&quot;&gt;Check ${item.link === &#39;toxicity&#39; ? &#39;Toxicity&#39; : &#39;Interaction&#39;} &amp;raquo;&lt;/button&gt;&lt;/div&gt;`
        : &#39;&#39;;

    // NATIVE HTML TOGGLE STRUCTURE
    const html = `
      &lt;div class=&quot;relative w-full bg-white border rounded-xl shadow-sm p-3&quot;&gt;
        &lt;input type=&quot;checkbox&quot; id=&quot;check-${key}&quot; class=&quot;toggle-checkbox&quot; onchange=&quot;handleToggleChange(&#39;${key}&#39;)&quot; ${isChecked ? &#39;checked&#39; : &#39;&#39;}&gt;
        &lt;label for=&quot;check-${key}&quot; class=&quot;flex justify-between items-start w-full cursor-pointer select-none&quot;&gt;
            &lt;div class=&quot;flex-1 mr-4&quot;&gt;
                &lt;span class=&quot;text-sm font-medium text-gray-700 block&quot;&gt;${item.text}&lt;/span&gt;
                &lt;div class=&quot;relative z-20 pointer-events-auto&quot; onclick=&quot;event.stopPropagation()&quot;&gt;
                    ${linkButtonHtml} 
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;relative w-12 h-6 rounded-full switch-bg flex-shrink-0 mt-1&quot;&gt;
                &lt;div class=&quot;absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/label&gt;
      &lt;/div&gt;
    `;
    clinicalTogglesEl.insertAdjacentHTML(&#39;beforeend&#39;, html);
  });
  
  // Restore static states
  [&#39;renal&#39;, &#39;liver&#39;, &#39;pregnancy&#39;, &#39;surgery&#39;, &#39;seizure&#39;, &#39;6months&#39;, &#39;dm&#39;, &#39;htn&#39;].forEach(id =&gt; {
      const el = document.getElementById(`check-${id}`);
      if (el) el.checked = loadState(id) === &#39;true&#39;;
  });
}

// --- CALCULATION ---
function calculateScore() {
  const checkSeizure = document.getElementById(&#39;check-seizure&#39;);
  const check6Months = document.getElementById(&#39;check-6months&#39;);
  
  const hasSeizure = checkSeizure?.checked;
  const lessThan6Months = check6Months?.checked;
  const prerequisiteMet = hasSeizure &amp;&amp; lessThan6Months;

  saveState(&#39;seizure&#39;, checkSeizure.checked);
  saveState(&#39;6months&#39;, check6Months.checked);

  if (!prerequisiteMet) {
      setCoreInputsDisabled(true);
      return; 
  }
  
  setCoreInputsDisabled(false);
  let score = 0;
  
  // ... (Rest of score calculation and status updates) ...

  updateIndicationStatus(score);
}


// --- INIT ---
window.onload = function() {
  // ... (Initialization logic)
  renderToggles();
  const inputs = [&#39;age&#39;, &#39;weight&#39;, &#39;height&#39;];
  inputs.forEach(id =&gt; {
      const el = document.getElementById(`input-${id}`);
      const val = loadState(id);
      if (el &amp;&amp; val) el.value = val;
      el?.addEventListener(&#39;input&#39;, () =&gt; saveState(id, el.value));
  });
  calculateScore();
  trackUtilization();
};

// Expose functions (essential for the HTML onclick handlers)
window.handleToggleChange = handleToggleChange;
window.calculateScore = calculateScore;
window.openModal = openModal;
window.closeModal = closeModal;
window.updateToxicityResults = updateToxicityResults;
window.checkInteraction = checkInteraction;
window.openChatModal = openChatModal; // Expose Chatbot Modal Opener
window.handleChatQuery = handleChatQuery; // Expose Chatbot Query Handler


</script>

</body>
</html>
