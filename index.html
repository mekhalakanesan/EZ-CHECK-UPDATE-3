<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPILEPSY EZ CHECK | JKWPKL&P</title>
  
  <!-- Tailwind CSS & Inter Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  
  <!-- FIREBASE IMPORTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const GITHUB_FIREBASE_CONFIG = {}; 
    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const finalConfig = Object.keys(envConfig).length > 0 ? envConfig : GITHUB_FIREBASE_CONFIG;
    
    if (Object.keys(finalConfig).length > 0 && finalConfig.projectId) {
      window.app = initializeApp(finalConfig);
      window.db = getFirestore(window.app);
    }
  </script>
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
    }
    
    .toggle-checkbox {
        position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0;
    }
    
    .toggle-checkbox:checked + label .switch-bg { background-color: #10b981; }
    .toggle-checkbox:checked + label .switch-dot { transform: translateX(1.5rem); }
    
    .switch-bg { transition: background-color 0.2s; background-color: #e5e7eb; }
    .switch-dot { transition: transform 0.2s; transform: translateX(0); }

    .input-field {
        border: none; border-radius: 0.5rem; padding: 0.75rem; text-align: right;
        font-weight: 700; color: #1e3a8a; background: transparent; width: 100%; outline: none;
    }
    .input-wrapper { transition: ring 0.2s; }
    .input-wrapper:focus-within { ring: 2px; ring-color: #6366f1; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center;
        z-index: 50; backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white; padding: 1.5rem; border-radius: 1rem; width: 95%; max-width: 650px;
        max-height: 90vh; overflow-y: auto; animation: scaleUp 0.2s ease-out;
    }
    @keyframes scaleUp {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* --- IMPROVED DISABLED STATE --- */
    /* Prevents interaction but keeps text perfectly readable */
    .disabled-area {
        pointer-events: none;
    }
    .disabled-area h2,
    .disabled-area .input-group,
    .disabled-area .switch-bg,
    .disabled-area .status-box,
    .disabled-area span:not(.link-button),
    .disabled-area p:not(.link-button) {
        opacity: 0.55; /* Increased opacity for better readability */
    }
    .disabled-area .bg-white { background-color: #fafafa; }

    .link-button {
        color: #2563eb !important; 
        opacity: 1 !important; 
        cursor: pointer !important;
        pointer-events: all !important;
        font-weight: 600; text-decoration: underline;
    }

    .compliance-card {
        border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.75rem;
        margin-bottom: 0.75rem; background: #ffffff;
    }
    .score-box-adherence {
        border: 3px dashed #cbd5e1; padding: 1.5rem; border-radius: 1rem;
        text-align: center; margin-top: 1.5rem;
    }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div id="app" class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mb-10">
    
    <header class="p-6 bg-indigo-700 text-white relative overflow-hidden">
      <div class="relative z-10 text-center">
        <h1 class="text-2xl font-extrabold tracking-tight uppercase">Epilepsy EZ Check</h1>
        <p class="text-sm mt-1 text-indigo-100 font-medium">TDM Indication Score Calculator</p>
        <p class="text-[10px] mt-1 opacity-60 tracking-widest font-bold uppercase">JKWPKL&P</p>
      </div>
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-600 rounded-full opacity-50"></div>
    </header>

    <div class="p-4 mx-6 mt-6 rounded-lg">
        <p class="text-[11px] italic text-gray-500 text-center">This tool is meant to support, not replace, clinical judgment.</p>
    </div>

    <main class="p-6 space-y-6">
        
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-2 uppercase">Seizure History</h2>
      <div id="seizure-history-gate" class="space-y-3 p-3 border border-gray-200 rounded-xl bg-white shadow-sm">
        <div class="flex justify-between items-center w-full">
            <span class="text-sm font-medium text-gray-700">1. Has breakthrough seizures?</span>
            <div class="relative">
                <input type="checkbox" id="check-seizure" class="toggle-checkbox">
                <label for="check-seizure" class="flex items-center cursor-pointer">
                    <div class="relative w-12 h-6 rounded-full switch-bg"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></div>
                </label>
            </div>
        </div>
        <div class="flex justify-between items-center w-full border-t border-gray-100 pt-3">
            <span class="text-sm font-medium text-gray-700">2. Seizure &lt; 6 months ago?</span>
            <div class="relative">
                <input type="checkbox" id="check-6months" class="toggle-checkbox">
                <label for="check-6months" class="flex items-center cursor-pointer">
                    <div class="relative w-12 h-6 rounded-full switch-bg"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></div>
                </label>
            </div>
        </div>
        <p class="text-[10px] italic text-gray-400 pt-1 text-center">Both must be YES to enable TDM scoring.</p>
      </div>
      
      <div id="calculator-core" class="transition-opacity duration-300">
          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6 uppercase">1. Demographics & BMI</h2>
          <div class="space-y-4">
            <div class="input-group">
              <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Age</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-age" placeholder="0" class="input-field">
                <span class="mr-3 text-gray-400 font-medium text-xs">yr</span>
              </div>
            </div>
            <div class="input-group">
              <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Weight</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-weight" placeholder="0.0" class="input-field">
                <span class="mr-3 text-gray-400 font-medium text-xs">kg</span>
              </div>
            </div>
            <div class="input-group">
              <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Height</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-height" placeholder="0.00" class="input-field">
                <span class="mr-3 text-gray-400 font-medium text-xs">m</span>
              </div>
            </div>
          </div>

          <div class="mt-4 p-3 rounded-xl text-center bg-gray-50 border border-gray-200 mb-6 status-box">
              <p id="calculated-bmi" class="text-2xl font-black text-gray-300 mt-1">--</p>
              <p id="bmi-status" class="text-[10px] font-bold mt-1 text-gray-400 h-4 uppercase"></p>
          </div>

          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6 uppercase">2. Comorbidities</h2>
          <div id="comorbidity-toggles" class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Renal Failure</span>
                <input type="checkbox" id="check-renal" class="toggle-checkbox">
                <label for="check-renal" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Liver Failure</span>
                <input type="checkbox" id="check-liver" class="toggle-checkbox">
                <label for="check-liver" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Diabetes Mellitus</span>
                <input type="checkbox" id="check-dm" class="toggle-checkbox">
                <label for="check-dm" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Hypertension</span>
                <input type="checkbox" id="check-htn" class="toggle-checkbox">
                <label for="check-htn" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
          </div>
          
          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4 uppercase">3. Special Populations</h2>
          <div id="special-population-check" class="space-y-3">
            <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50 status-box" id="age-child-pop-box">
                <div class="flex justify-between items-center">
                    <p class="text-sm font-medium text-gray-700">Children/adolescent (&lt;20)</p>
                    <p id="age-child-pop-status" class="text-[10px] font-black text-gray-400 uppercase">NOT MET</p>
                </div>
            </div>
            <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50 status-box" id="age-geriatric-pop-box">
                <div class="flex justify-between items-center">
                    <p class="text-sm font-medium text-gray-700">Elderly (&ge;65 yr)</p>
                    <p id="age-geriatric-pop-status" class="text-[10px] font-black text-gray-400 uppercase">NOT MET</p>
                </div>
            </div>
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Pregnant</span>
                <input type="checkbox" id="check-pregnancy" class="toggle-checkbox">
                <label for="check-pregnancy" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
            <div class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm status-box">
                <span class="text-sm font-medium text-gray-700">Post-Major Surgery (&lt;3mo)</span>
                <input type="checkbox" id="check-surgery" class="toggle-checkbox">
                <label for="check-surgery" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label>
            </div>
          </div>

          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4 uppercase">4. Clinical Factors</h2>
          <div id="clinical-toggles" class="space-y-3"></div>
      </div> 

      <!-- Standalone AI Button -->
      <button id="main-ai-btn" class="w-full mt-4 py-4 bg-green-600 text-white font-bold rounded-2xl shadow-lg hover:bg-green-700 transition flex items-center justify-center space-x-2 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span>Ask the Epilepsy AI</span>
      </button>

    </main>

    <footer class="p-6 bg-indigo-50 border-t border-indigo-100 text-center">
      <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Total Criteria Met</p>
      <div id="final-score" class="text-6xl font-black text-gray-300 mt-1 transition-colors duration-300">0</div>
      <div id="indication-box" class="mt-4 p-4 rounded-xl text-center shadow-lg transition-all duration-300 bg-gray-200 text-gray-500">
        <p id="indication-text" class="text-xl font-extrabold uppercase">NO INDICATION</p>
      </div>
      <p class="text-right text-[9px] text-gray-400 mt-6">&copy; JKWPKL&P 2025 | v2.6</p>
    </footer>

    <!-- SHARED TOOL MODAL -->
    <div id="drug-checker-modal" class="modal-overlay">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Tool</h3>
                <button id="close-checker-btn" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- CHATBOT MODAL -->
    <div id="epilepsy-chatbot-modal" class="modal-overlay">
        <div class="modal-content shadow-2xl max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-700">Epilepsy AI Reference</h3>
                <button id="close-chat-btn" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">&times;</button>
            </div>
            <div id="chat-container" class="h-96 flex flex-col justify-between">
                <div id="chat-history" class="overflow-y-auto p-4 bg-slate-50 border rounded-xl mb-3 space-y-3 flex flex-col text-xs">
                    <div class="bg-indigo-100 text-indigo-800 p-2 rounded-lg text-xs self-start max-w-[85%]">Hi, ask me about epilepsy management in malaysia</div>
                </div>
                <form id="chat-form" class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 outline-none">
                    <button type="submit" id="chat-send-btn" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">Ask</button>
                </form>
            </div>
        </div>
    </div>

  </div>

  <script type="module">
    // --- !!! PASTE YOUR API KEY (STARTING WITH AIzaSy) BETWEEN THE QUOTES BELOW !!! ---
    const apiKey = "AIzaSyAJ_-0ppdXtWD40j0zWp2mfJG8DlUh8YR8"; 
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    const ASM_OPTIONS = ["VALPROIC ACID", "CARBAMAZEPINE", "PHENYTOIN", "PHENOBARBITONE"];

    const ASM_ADR_TOXICITY = {
        "VALPROIC ACID": { adr: "Hepatotoxicity, Pancreatitis, Alopecia, SJS, Hyperammonemic encephalopathy", toxicity: "Sedation, vomiting, tachycardia, respiratory depression" },
        "CARBAMAZEPINE": { adr: "SJS, TEN, Agranulocytosis, Hepatitis, Blurred vision, Nystagmus", toxicity: "Drowsiness, slurred speech, ataxia, nausea, hypotension" },
        "PHENYTOIN": { adr: "Nystagmus (>20 mg/L), Ataxia (>30 mg/L), Diminished mental capacity (>40 mg/L), SJS, TEN", toxicity: "Tremor, agitation, confusion, vomiting, hallucinations" },
        "PHENOBARBITONE": { adr: "Ataxia, Mental dullness, Megaloblastic anaemia, SJS", toxicity: "Somnolence, slurred speech, coma, hypotension, respiratory failure" }
    };

    const ASM_INTERACTIONS = {
        "VALPROIC ACID": { "inc": ["Cimetidine", "Topiramate"], "dec": ["Carbapenem", "Rifampicin"] },
        "PHENYTOIN": { "inc": ["Amiodarone", "Azoles", "Isoniazid", "PPIs", "SSRIs"], "dec": ["Rifampin", "Theophylline", "VPA"] },
        "PHENOBARBITONE": { "inc": ["Clarithromycin", "VPA"], "dec": ["Mefloquine", "Orlistat", "Rifamycin"] },
        "CARBAMAZEPINE": { "inc": ["Erythromycin", "Fluoxetine", "Grapefruit", "Isoniazid"], "dec": ["Cisplatin", "Rifampicin", "Theophylline"] }
    };

    const CRITERIA = [
      { id: 'sleep', text: 'Seizure occurs during sleep' },
      { id: 'dose', text: 'Any drug/dose changes (ASM only)' },
      { id: 'sub', text: 'Suspected subtherapeutic dose' },
      { id: 'tox', text: 'Suspected adverse effect / toxicity', link: 'toxicity' },
      { id: 'med', text: 'Changes in medication (Brand / Formulation)' },
      { id: 'comp', text: 'Poor compliance suspected', link: 'compliance' },
      { id: 'int', text: 'Any suspected interaction', link: 'interaction' },
    ];

    const load = (id) => localStorage.getItem(`ep-${id}`);
    const save = (id, val) => localStorage.setItem(`ep-${id}`, val);

    function display(sender, text) {
        const hist = document.getElementById('chat-history');
        const bubble = sender === 'user' ? 'bg-indigo-600 text-white self-end' : 'bg-gray-200 text-gray-800 self-start';
        const div = document.createElement('div');
        div.className = `${bubble} p-2 rounded-lg text-xs max-w-[85%] mb-2`;
        div.textContent = text;
        hist.appendChild(div);
        hist.scrollTop = hist.scrollHeight;
    }

    async function handleChat() {
        const input = document.getElementById('chat-input'), query = input.value.trim();
        if (!query) return;
        if (!apiKey) { alert("Missing API Key in Line 212."); return; }
        display('user', query); input.value = '';
        const loading = document.createElement('div');
        loading.className = "text-gray-400 italic mb-2 text-[10px]";
        loading.textContent = "Thinking...";
        document.getElementById('chat-history').appendChild(loading);

        try {
            const prompt = `You are a knowledge assistant for epilepsy in Malaysia. Provide simple, short, plain text answers. DO NOT use markdown, asterisks (*), bolding (**), or lists. Use only plain sentences. No citations. Answer based on Malaysian Epilepsy Guidelines.`;
            const resp = await fetch(GEMINI_API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: query }] }], systemInstruction: { parts: [{ text: prompt }] } }) });
            const data = await resp.json();
            loading.remove();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            display('ai', text.replace(/\*/g, ''));
        } catch (e) { loading.textContent = "Error."; }
    }

    function calculateScore() {
      const g1 = document.getElementById('check-seizure').checked, g2 = document.getElementById('check-6months').checked;
      const core = document.getElementById('calculator-core');
      save('seizure', g1); save('6months', g2);
      if (!(g1 && g2)) { core.classList.add('disabled-area'); document.getElementById('final-score').textContent="0"; return; }
      core.classList.remove('disabled-area');
      let score = 0;
      const w = parseFloat(document.getElementById('input-weight').value), h = parseFloat(document.getElementById('input-height').value);
      if (w > 0 && h > 0) {
          const bmi = w / (h * h); document.getElementById('calculated-bmi').textContent = bmi.toFixed(1);
          if (bmi >= 27.5 || bmi <= 18.5) { score++; document.getElementById('bmi-status').textContent = bmi >= 27.5 ? 'OBESE' : 'LOW BMI'; } else document.getElementById('bmi-status').textContent = 'NORMAL';
      }
      const age = parseFloat(document.getElementById('input-age').value);
      if (age > 0 && age < 20) { score++; document.getElementById('age-child-pop-status').textContent='MET'; } else document.getElementById('age-child-pop-status').textContent='NOT MET';
      if (age >= 65) { score++; document.getElementById('age-geriatric-pop-status').textContent='MET'; } else document.getElementById('age-geriatric-pop-status').textContent='NOT MET';
      ['renal', 'liver', 'dm', 'htn', 'pregnancy', 'surgery'].forEach(id => { if(document.getElementById(`check-${id}`).checked) score++; });
      CRITERIA.forEach(c => { if(document.getElementById(`check-${c.id}`).checked) score++; });
      document.getElementById('final-score').textContent = score;
      document.getElementById('indication-box').className = score > 0 ? "mt-4 p-4 rounded-xl text-center shadow-lg bg-indigo-600 text-white animate-pulse" : "mt-4 p-4 rounded-xl text-center shadow-lg bg-gray-200 text-gray-500";
      document.getElementById('indication-text').textContent = score > 0 ? "TDM IS INDICATED" : "NO INDICATION";
    }

    window.openAssessment = (type) => {
        const m = document.getElementById('drug-checker-modal'), body = document.getElementById('modal-body'), title = document.getElementById('modal-title');
        m.style.display = 'flex';
        if (type === 'toxicity') {
            title.textContent = 'ADR & Toxicity';
            body.innerHTML = `<select id="as" class="w-full p-3 bg-gray-50 border rounded-lg font-bold outline-none"><option value="">-- Select --</option>${ASM_OPTIONS.map(d=>`<option value="${d}">${d}</option>`).join('')}</select><div id="tr" class="p-4 bg-blue-50 rounded-lg mt-4 hidden"></div>`;
            document.getElementById('as').onchange = (e) => { const d = ASM_ADR_TOXICITY[e.target.value]; document.getElementById('tr').classList.remove('hidden'); document.getElementById('tr').innerHTML = `<p class="text-xs"><strong>ADR:</strong> ${d.adr}</p><p class="text-xs mt-2"><strong>Toxicity:</strong> ${d.toxicity}</p>`; };
        } else if (type === 'compliance') {
            title.textContent = 'Adherence Checklist';
            body.innerHTML = `<div class="text-center text-[10px] text-gray-400 mb-2 uppercase font-bold">1pt for every "No"</div><div id="cq"></div><button id="calc-c" class="w-full bg-indigo-600 text-white py-3 rounded-xl mt-4 font-bold">Score</button><div id="cr"></div>`;
            const qs = ["Missed dose in past month?", "Forgotten dose in past month?", "Stopped because felt well?", "Reduced due to side effects?", "Uncertain about timing?", "Late to refill?", "Rely on others?", "Trouble managing schedule?"];
            document.getElementById('cq').innerHTML = qs.map((q,i)=>`<div class="compliance-card"><p class="text-sm font-medium mb-2">${i+1}. ${q}</p><label class="mr-4 text-red-600 font-bold"><input type="radio" name="r${i}" value="0"> Yes</label><label class="text-green-600 font-bold"><input type="radio" name="r${i}" value="1"> No</label></div>`).join('');
            document.getEleamentById('calc-c').onclick = () => { let s=0, c=0; for(let i=0;i<8;i++){ const r=document.querySelector(`input[name="r${i}"]:checked`); if(r){s+=parseInt(r.value); c++;} } if(c<8){ alert("Answer all 8."); return; } document.getElementById('cr').className="mt-4 p-4 rounded-xl bg-blue-50 border-2 border-dashed text-center font-bold"; document.getElementById('cr').innerHTML = `Score: ${s}/8<br>${s>=7?'High Compliance':(s>=5?'Moderate':'Poor')}`; };
        } else if (type === 'interaction') {
            title.textContent = 'Interactions';
            body.innerHTML = `<input type="text" id="i2" placeholder="Search drug..." class="w-full p-3 border rounded-xl outline-none"><div class="mt-4 text-xs text-gray-400 italic">Manual lookup for interaction suspected.</div>`;
        }
    };

    window.onload = () => {
        const ct = document.getElementById('clinical-toggles');
        CRITERIA.forEach(c => {
            const row = `<div class="flex justify-between items-start p-3 bg-white border rounded-xl shadow-sm"><div class="flex-1 mr-4"><span class="text-sm font-medium text-gray-700 block">${c.text}</span>${c.link ? `<button class="link-button text-xs pointer-events-auto" onclick="openAssessment('${c.link}')">Check ${c.link} &raquo;</button>` : ''}</div><input type="checkbox" id="check-${c.id}" class="toggle-checkbox"><label for="check-${c.id}" class="w-12 h-6 rounded-full switch-bg relative cursor-pointer mt-1"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></label></div>`;
            ct.insertAdjacentHTML('beforeend', row);
        });
        
        // Event Listeners for Buttons (Fixes the "Unclickable" issue)
        document.getElementById('main-ai-btn').onclick = () => document.getElementById('epilepsy-chatbot-modal').style.display='flex';
        document.getElementById('close-chat-btn').onclick = () => document.getElementById('epilepsy-chatbot-modal').style.display='none';
        document.getElementById('close-checker-btn').onclick = () => document.getElementById('drug-checker-modal').style.display='none';
        document.getElementById('chat-form').onsubmit = (e) => { e.preventDefault(); handleChat(); };

        // Attach Scoring listeners
        document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculateScore));
        calculateScore();
    };

    window.handleToggleChange = calculateScore; // Map to global for any leftover inline calls
  </script>
</body>
</html>
