<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPILEPSY EZ CHECK | JKWPKL&P</title>
  
  <!-- Tailwind CSS & Inter Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  
  <!-- FIREBASE IMPORTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const GITHUB_FIREBASE_CONFIG = {}; 
    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const finalConfig = Object.keys(envConfig).length > 0 ? envConfig : GITHUB_FIREBASE_CONFIG;
    
    if (Object.keys(finalConfig).length > 0 && finalConfig.projectId) {
      window.app = initializeApp(finalConfig);
      window.db = getFirestore(window.app);
      console.log("Firebase initialized successfully.");
    } else {
      console.warn("Firebase configuration missing.");
      window.db = null;
    }
  </script>
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
    }
    
    .toggle-checkbox {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    .toggle-checkbox:checked + label .switch-bg {
        background-color: #10b981;
    }
    .toggle-checkbox:checked + label .switch-dot {
        transform: translateX(100%);
    }
    
    .switch-bg {
        transition: background-color 0.2s ease-in-out;
        background-color: #e5e7eb;
    }
    .switch-dot {
        transition: transform 0.2s ease-in-out;
        transform: translateX(0);
    }

    .input-field {
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: right;
        font-weight: 700;
        color: #1e3a8a;
        background: transparent;
        width: 100%;
        outline: none;
    }
    .input-wrapper {
        transition: ring 0.2s;
    }
    .input-wrapper:focus-within {
        ring: 2px;
        ring-color: #6366f1;
    }

    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center; align-items: center;
        z-index: 50;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        width: 95%; max-width: 650px; max-height: 90vh;
        overflow-y: auto;
        animation: scaleUp 0.2s ease-out;
    }
    @keyframes scaleUp {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* --- IMPROVED DISABLED STATE --- */
    .disabled-area {
        pointer-events: none;
    }
    .disabled-area h2,
    .disabled-area .input-group,
    .disabled-area #comorbidity-toggles,
    .disabled-area #special-population-check,
    .disabled-area .switch-bg,
    .disabled-area span:not(.link-button),
    .disabled-area p:not(.link-button) {
        opacity: 0.4;
        filter: grayscale(100%);
    }

    /* Vibrant Blue Link Buttons */
    .link-button {
        color: #2563eb !important; /* Blue-600 */
        opacity: 1 !important;
        filter: none !important;
        cursor: pointer !important;
        pointer-events: all !important;
        font-weight: 600;
        text-decoration: underline;
    }

    .pointer-events-auto {
        pointer-events: all !important;
    }
    
    /* Adherence Checklist Styling within Modal */
    .compliance-card {
        border: 1px solid #e5e7eb;
        padding: 1rem;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
        background: #ffffff;
    }
    .score-box-adherence {
        border: 3px dashed #cbd5e1;
        padding: 1.5rem;
        border-radius: 1rem;
        text-align: center;
        margin-top: 1.5rem;
    }
  </style>
</head>
<body class="p-4 sm:p-8">
  <div id="app" class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mb-10">
    
    <header class="p-6 bg-indigo-700 text-white relative overflow-hidden">
      <div class="relative z-10">
        <h1 class="text-2xl font-extrabold text-center tracking-tight">EPILEPSY EZ CHECK</h1>
        <p class="text-sm text-center mt-1 text-indigo-100 font-medium">
            TDM Indication Score Calculator
        </p>
        <p class="text-xs text-center mt-1 opacity-60 tracking-widest">
            JKWPKL&P
        </p>
      </div>
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-600 rounded-full opacity-50"></div>
    </header>

    <div class="p-4 mx-6 mt-6 rounded-lg">
        <p class="text-xs italic text-gray-500 text-center">
            This tool is meant to support, not replace, clinical judgment.
        </p>
    </div>

    <main class="p-6 space-y-6">
        
      <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-2 flex items-center gap-2">
          SEIZURE HISTORY
      </h2>
      <div id="seizure-history-gate" class="space-y-3 p-3 border border-gray-200 rounded-xl bg-white shadow-sm">
        <div class="relative w-full">
            <input type="checkbox" id="check-seizure" class="toggle-checkbox" onchange="calculateScore()">
            <label for="check-seizure" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700">1. Has breakthrough seizures?</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>
        <div class="relative w-full border-t border-gray-100 pt-3">
            <input type="checkbox" id="check-6months" class="toggle-checkbox" onchange="calculateScore()">
            <label for="check-6months" class="flex justify-between items-center w-full cursor-pointer select-none">
                <span class="text-sm font-medium text-gray-700">2. Seizure &lt; 6 months ago?</span>
                <div class="relative w-12 h-6 rounded-full switch-bg">
                    <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                </div>
            </label>
        </div>
        <p class="text-xs italic text-gray-400 pt-1 text-center">Both must be YES to enable TDM scoring.</p>
      </div>
      
      <div id="calculator-core" class="transition-opacity duration-300">
          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6">1. Demographics & BMI</h2>
          <div class="grid grid-cols-2 gap-4">
            <div class="input-group">
              <label for="input-age" class="block text-xs font-bold uppercase text-gray-500 mb-1">Age</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-age" min="0" max="150" placeholder="0" class="input-field" oninput="calculateScore()">
                <span class="mr-3 text-gray-400 font-medium text-xs">yr</span>
              </div>
            </div>
            <div class="input-group">
              <label for="input-weight" class="block text-xs font-bold uppercase text-gray-500 mb-1">Weight</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-weight" min="1" step="0.1" placeholder="0.0" class="input-field" oninput="calculateScore()">
                <span class="mr-3 text-gray-400 font-medium text-xs">kg</span>
              </div>
            </div>
            <div class="input-group">
              <label for="input-height" class="block text-xs font-bold uppercase text-gray-500 mb-1">Height</label>
              <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 input-wrapper">
                <input type="number" id="input-height" min="0.1" step="0.01" placeholder="0.00" class="input-field" oninput="calculateScore()">
                <span class="mr-3 text-gray-400 font-medium text-xs">m</span>
              </div>
            </div>
          </div>

          <div class="mt-4 p-4 rounded-xl text-center bg-indigo-50 border border-indigo-200 shadow-sm">
              <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest">BMI (kg/m²)</p>
              <p id="calculated-bmi" class="text-3xl font-black text-gray-300 mt-1">--</p>
              <p id="bmi-status" class="text-xs font-bold mt-1 text-gray-400 h-4"></p>
          </div>

          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 mb-4 mt-6">2. Comorbidities</h2>
          <div id="comorbidity-toggles" class="space-y-3">
            <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-renal" class="toggle-checkbox" onchange="handleToggleChange('renal')">
                <label for="check-renal" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-700">Renal Failure</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
            <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-liver" class="toggle-checkbox" onchange="handleToggleChange('liver')">
                <label for="check-liver" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-700">Liver Failure</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
            <div class="relative w-full bg-gray-50 border border-gray-200 rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-dm" class="toggle-checkbox" onchange="handleToggleChange('dm')">
                <label for="check-dm" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-500">Diabetes Mellitus</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
            <div class="relative w-full bg-gray-50 border border-gray-200 rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-htn" class="toggle-checkbox" onchange="handleToggleChange('htn')">
                <label for="check-htn" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-500">Hypertension</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
          </div>
          
          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4">3. Special Population</h2>
          <div id="special-population-check" class="space-y-3">
            <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50" id="age-child-pop-box">
                <div class="flex justify-between items-center">
                    <p class="text-sm font-medium text-gray-700">Children (&lt;20 yr)</p>
                    <p id="age-child-pop-status" class="text-xs font-black text-gray-400">NOT MET</p>
                </div>
            </div>
            <div class="p-3 rounded-xl shadow-sm border border-gray-200 bg-gray-50" id="age-geriatric-pop-box">
                <div class="flex justify-between items-center">
                    <p class="text-sm font-medium text-gray-700">Elderly (&ge;65 yr)</p>
                    <p id="age-geriatric-pop-status" class="text-xs font-black text-gray-400">NOT MET</p>
                </div>
            </div>
            <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-pregnancy" class="toggle-checkbox" onchange="handleToggleChange('pregnancy')">
                <label for="check-pregnancy" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-700">Pregnant</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
            <div class="relative w-full bg-white border rounded-xl shadow-sm p-3">
                <input type="checkbox" id="check-surgery" class="toggle-checkbox" onchange="handleToggleChange('surgery')">
                <label for="check-surgery" class="flex justify-between items-center w-full cursor-pointer select-none">
                    <span class="text-sm font-medium text-gray-700 w-3/4">Post-Major Surgery (&lt;3mo)</span>
                    <div class="relative w-12 h-6 rounded-full switch-bg">
                        <div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div>
                    </div>
                </label>
            </div>
          </div>

          <h2 class="text-lg font-bold text-indigo-700 border-b pb-2 pt-6 mb-4">4. Clinical Factors</h2>
          <div id="clinical-toggles" class="space-y-3"></div>
      </div> 

      <button id="open-chatbot-btn" onclick="openChatModal()" class="w-full mt-6 py-3 px-4 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span>Ask the Epilepsy AI</span>
      </button>

    </main>

    <footer id="score-footer" class="p-6 bg-gray-50 border-t border-gray-200">
      <div class="text-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Positive Criteria</p>
        <div id="final-score" class="text-6xl font-black text-gray-300 mt-1 transition-colors duration-300">
          0
        </div>
      </div>
      
      <div id="indication-box" class="mt-4 p-4 rounded-xl text-center shadow-lg transition-all duration-300 bg-gray-200 text-gray-500">
        <p class="text-xs font-bold uppercase tracking-wider mb-1">Status</p>
        <p id="indication-text" class="text-xl font-extrabold">NO INDICATION</p>
      </div>

      <div class="flex justify-end items-end text-xs text-gray-400 mt-6 border-t pt-4">
          <div class="text-right">
              <p>&copy; JKWPKL&P 2025</p>
              <p class="text-[10px] opacity-70">v2.1 Stable</p>
          </div>
      </div>
    </footer>

    <!-- SHARED TOOL MODAL -->
    <div id="drug-checker-modal" class="modal-overlay" onclick="closeModal(event, 'drug-checker-modal')">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Drug Checker</h3>
                <button onclick="document.getElementById('drug-checker-modal').style.display='none';" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">
                    &times;
                </button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- CHATBOT MODAL -->
    <div id="epilepsy-chatbot-modal" class="modal-overlay" onclick="closeModal(event, 'epilepsy-chatbot-modal')">
        <div class="modal-content shadow-2xl max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-700">Epilepsy Reference Chatbot</h3>
                <button onclick="document.getElementById('epilepsy-chatbot-modal').style.display='none';" class="text-gray-400 hover:text-red-500 text-3xl font-light leading-none focus:outline-none">
                    &times;
                </button>
            </div>
            <div id="chat-container" class="h-96 flex flex-col justify-between">
                <div id="chat-history" class="overflow-y-auto p-2 space-y-3 flex-1 mb-4 border rounded-lg bg-gray-50">
                    <div class="text-sm text-gray-500 text-center p-2">
                        Ask me anything about Epilepsy Management or TDM using the linked Malaysian guidelines.
                    </div>
                </div>
                <form id="chat-form" class="flex space-x-2" onsubmit="event.preventDefault(); handleChatQuery()">
                    <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <button type="submit" id="chat-send-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

  </div>

  <script type="module">
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'epilepsy-ez-check-app';
    const apiKey = "AIzaSyAJ_-0ppdXtWD40j0zWp2mfJG8DlUh8YR8"; 
    const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025'; 
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

    const ASM_OPTIONS = ["VALPROIC ACID", "CARBAMAZEPINE", "PHENYTOIN", "PHENOBARBITONE"];

    const TDM_GUIDE_CONTENT = `
    --- CLINICAL PHARMACOKINETICS PHARMACY HANDBOOK (2ND ED) ---
    - CARBAMAZEPINE (CBZ): Therapeutic Range: 4-12 mg/L. Vd: 0.6-2 L/kg. Clearance: Auto-inducer (CYP3A4). Drug Interactions: Inhibitors (Clarithromycin, Diltiazem, Grapefruit juice) increase CBZ concentration. Inducers (Phenobarbital, Rifampicin) decrease CBZ concentration. ADR: Steven-Johnson syndrome, Toxic epidermal necrolysis.
    - PHENYTOIN (PHT): Therapeutic Range: 10-20 mg/L. Metabolism: Nonlinear (Michaelis-Menten kinetics). High protein binding (90-95%). ADR: Far lateral nystagmus (>20 mg/L), Ataxia (>30 mg/L). Interactions: Fluoxetine, Isoniazid increase PHT. Carbamazepine, Valproic Acid decrease PHT.
    - PHENOBARBITONE (PB): Therapeutic Range: 15-40 mg/L. Half-life: 96 hours (Adults). Clearance: 0.004 L/kg/hr (Adults). ADR: Sedation (>5 mg/L), Impaired cognition (>19 mg/L), Coma (>=65 mg/L).
    - VALPROIC ACID (VPA): Therapeutic Range: 50-100 mg/L. High protein binding (90-95%) and concentration-dependent. Clearance: Hepatic, 7-12 ml/kg/hr (Adult Mono). ADR: Hepatotoxicity, Pancreatitis, Thrombocytopenia, Hyperammonemic encephalopathy.
    --- END HANDBOOK CONTENT ---
    `;

    const ASM_ADR_TOXICITY = {
        "VALPROIC ACID": { adr: "Hepatotoxicity, Pancreatitis, Alopecia, Thrombocytopenia, Steven-Johnson syndrome, Hyperammonemic encephalopathy", toxicity: "CNS depression such as lethargy, sedation, vomiting, tachycardia, hypotension and respiratory depression" },
        "CARBAMAZEPINE": { adr: "Steven-Johnson syndrome, Toxic epidermal necrolysis, Agranulocytosis, Thrombocytopenia, Leukopenia, Pancytopenia, Hepatitis, Hepatotoxicity, Angioedema, Blurred vision, Nystagmus", toxicity: "Drowsiness, slurred speech, ataxia, hallucination, nausea & vomiting, hypotension, seizures, respiratory depression, coma" },
        "PHENYTOIN": { adr: "Far lateral nystagmus (>20 mg/L), Ataxia (>30 mg/L), Diminished mental capacity (>40 mg/L), Hepatotoxicity, Hematological disorders, Steven-Johnson syndrome, Toxic epidermal necrolysis", toxicity: "Nystagmus, ataxia, tremor, irritability or agitation, confusion, vomiting, lethargy, hallucinations, coma" },
        "PHENOBARBITONE": { adr: "Ataxia, Mental dullness, Paresthesia restlessness, Megaloblastic anaemia, Hepatotoxicity, Hypocalcaemia, Steven-Johnson syndrome", toxicity: "Somnolence, slurred speech, nystagmus, ataxia, coma, hypotension, decreased myocardial contractility, hypothermia and respiratory failure" }
    };

    const ASM_INTERACTIONS = {
        "VALPROIC ACID": { "increased_by": ["Cimetidine", "Chlorpromazine", "Felbamate", "Topiramate"], "decreased_by": ["Carbamazepine", "Carbapenem", "Lamotrigine", "Phenytoin", "Phenobarbitone", "Primidone", "Rifampicin"] },
        "PHENYTOIN": { "increased_by": ["Allopurinol", "Amiodarone", "Azole derivatives", "Calcium Channel Blocker", "Carbamazepine", "Cefazolin", "Chloramphenicol", "Fluoxetine", "Fluvoxamine", "Vitamin K Antagonist", "Hydroxyzine", "Isoniazid", "Proton Pump Inhibitors", "Serotonin Reuptake Inhibitors", "Sulfonamide Derivatives", "Tacrolimus", "Ticlopidine", "Topiramate", "Trimethoprim"], "decreased_by": ["Carbamazepine", "Ciprofloxacin", "Folic Acid", "Methotrexate", "Pyridoxine", "Rifampin", "Ritonavir z", "Theophylline", "Valproic Acid"] },
        "PHENOBARBITONE": { "increased_by": ["Carbonic Anhydrase inhibitor", "Chloramphenicol", "Clarithromycin", "Hydroxyzine", "Magnesium Sulphate", "Methylphenidate", "Phenytoin", "Primidone", "Quinine", "Valproic Acid and Derivative"], "decreased_by": ["Amphetamine", "Cholestyramine Resin", "Folic Acid", "Ketorolac", "Leucovorin Calcium", "Mefloquine", "Multivitamins/ Minerals", "Orlistat", "Pyridoxine", "Rifamycin derivative", "Tipranavir"] },
        "CARBAMAZEPINE": { "increased_by": ["Clarithromycin", "Diltiazem", "Erythromycin", "Fluoxetine", "Grapefruit juice", "Isoniazid", "Loratadine", "Valproate", "Verapamil", "Azole antifungals", "Fluconazole, Itraconazole, Ketoconazole", "Protease inhibitors: Indinavir, Nelfinavir, Ritonavir"], "decreased_by": ["Cisplatin", "Doxorubicin", "Phenobarbital", "Phenytoin", "Primidone", "Rifampicin", "Theophylline", "Carbamazepine (autoinduction)"] }
    };

    const COMPLIANCE_QUESTIONS = [
        "In the past month, did you miss taking your Anti-Seizure Medication (ASM) as prescribed (e.g., skip a dose, or take it alternately)?",
        "In the past month, have you ever forgotten to take your ASM dose?",
        "Have you stopped or reduced your ASM because you felt seizure-free or thought the medication was unnecessary?",
        "Have you reduced your dose because you were worried about side effects (or potential long-term harm to your body)?",
        "Are you uncertain about the correct dosage, frequency, or timing for any of your Anti-Seizure Medications?",
        "Have you missed an appointment or been late to refill your medication supply in the last three months, leading to running out?",
        "Do you rely solely on someone else to remind you, and sometimes miss your ASM dose if they don't?",
        "Do you feel you have trouble managing your medication (e.g., keeping track of timing, handling complex schedules, or running out)?",
    ];

    const CRITERIA_TOGGLES = [
      { id: '2', text: 'Seizure occurs during sleep' },
      { id: '3', text: 'Any drug/dose changes (ASM only)' },
      { id: '4', text: 'Suspected subtherapeutic dose' },
      { id: '5', text: 'Suspected adverse effect / toxicity', link: 'toxicity' },
      { id: '6a', text: 'Changes in medication (Brand / Formulation)' },
      { id: '7', text: 'Poor compliance suspected', link: 'compliance' },
      { id: '8', text: 'Any suspected interaction', link: 'interaction' },
    ];

    const getStorageKey = (id) => `epilepsy-ez-${id}`;
    const loadState = (id) => localStorage.getItem(getStorageKey(id));
    const saveState = (id, value) => localStorage.setItem(getStorageKey(id), value);

    function displayMessage(sender, text) {
        const history = document.getElementById('chat-history');
        const isUser = sender === 'user';
        const msgClass = isUser ? 'text-right' : 'text-left';
        const bubbleClass = isUser ? 'bg-indigo-500 text-white ml-auto' : 'bg-white text-gray-800 mr-auto shadow';
        const messageDiv = document.createElement('div');
        messageDiv.className = msgClass;
        messageDiv.innerHTML = `<span class="${bubbleClass} inline-block px-4 py-2 rounded-xl max-w-[80%] text-sm">${text}</span>`;
        history.appendChild(messageDiv);
        history.scrollTop = history.scrollHeight;
    }

    function openChatModal() {
        document.getElementById('epilepsy-chatbot-modal').style.display = 'flex';
        const history = document.getElementById('chat-history');
        if (history.children.length > 1) {
            history.innerHTML = `<div class="text-sm text-gray-500 text-center p-2">Ask me anything about Epilepsy Management or TDM using the linked Malaysian guidelines.</div>`;
        }
    }
    
    async function retryFetch(url, options, retries = 3) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) return response;
                if (response.status >= 400 && response.status < 500) throw new Error(`Client Error: ${response.status}`);
                const delay = Math.pow(2, i) * 1000; 
                await new Promise(resolve => setTimeout(resolve, delay));
            } catch (error) { if (i === retries - 1) throw error; }
        }
        throw new Error("API request failed.");
    }

    async function handleChatQuery() {
        const input = document.getElementById('chat-input');
        const query = input.value.trim();
        const sendBtn = document.getElementById('chat-send-btn');
        const history = document.getElementById('chat-history');
        if (!query) return;
        displayMessage('user', query);
        input.value = '';
        sendBtn.disabled = true;
        const loadingId = 'loading-msg';
        displayMessage('ai', `<div id="${loadingId}" class="flex items-center justify-center space-x-1"><svg class="animate-spin h-4 w-4 text-indigo-500" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#a5b4fc" stroke-width="4" fill="none"></circle><path d="M12 2v4M12 18v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M3 12h4M17 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83" stroke="#4f46e5" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path></svg><span>Thinking...</span></div>`);
        try {
            const systemPrompt = `You are a Clinical Pharmacist Assistant for epilepsy management. Base all your responses STRICTLY on the Malaysian Consensus Guidelines and Pharmacokinetics Handbook. ${TDM_GUIDE_CONTENT} Your final answer MUST be simple and concise. DO NOT include any references.`;
            const payload = { contents: [{ parts: [{ text: query }] }], tools: [{ "google_search": {} }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const response = await retryFetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }, 3);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I was unable to retrieve an answer.";
            document.getElementById(loadingId)?.closest('.text-left')?.remove();
            displayMessage('ai', text);
        } catch (error) {
            document.getElementById(loadingId)?.closest('.text-left')?.remove();
            displayMessage('ai', `Error lookup: ${error.message}`);
        } finally { sendBtn.disabled = false; }
    }

    function openModal(type) {
        const modal = document.getElementById('drug-checker-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        if (type === 'toxicity') {
            modalTitle.textContent = 'ASM ADR & Toxicity Checker';
            const options = ASM_OPTIONS.map(d => `<option value="${d}">${d}</option>`).join('');
            modalBody.innerHTML = `<div class="space-y-4"><label class="block text-sm font-bold text-gray-700">Select Medication</label><select id="asm-select" class="w-full p-3 bg-gray-50 border rounded-lg outline-none focus:ring-2 ring-indigo-500" onchange="updateToxicityResults(this.value)"><option value="">-- Select --</option>${options}</select><div id="tox-res" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-500 text-center min-h-[100px] flex items-center justify-center">Select a drug above.</div></div>`;
        } else if (type === 'interaction') {
            modalTitle.textContent = 'Interaction Checker';
            const options = ASM_OPTIONS.map(d => `<option value="${d}">${d}</option>`).join('');
            modalBody.innerHTML = `<div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Index Drug (ASM)</label><select id="asm1" class="w-full p-3 bg-gray-50 border rounded-lg outline-none focus:ring-2 ring-indigo-500" onchange="checkInteraction()"><option value="">-- Select --</option>${options}</select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Interacting Drug</label><input id="drug2" type="text" placeholder="e.g. Rifampicin" class="w-full p-3 bg-gray-50 border rounded-lg outline-none focus:ring-2 ring-indigo-500" oninput="checkInteraction()"></div><div id="int-res" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-500 text-center">Select an ASM and type a second drug.</div></div>`;
        } else if (type === 'compliance') {
            modalTitle.textContent = 'ASM Adherence Checklist';
            let qHtml = COMPLIANCE_QUESTIONS.map((q, i) => `
                <div class="compliance-card">
                    <p class="text-sm font-medium text-gray-900 mb-3"><span class="text-indigo-600 font-bold">${i+1}.</span> ${q}</p>
                    <div class="flex space-x-6">
                        <label class="flex items-center cursor-pointer"><input type="radio" name="cq${i+1}" value="0" class="w-4 h-4 text-red-600"><span class="ml-2 text-sm text-red-600 font-bold">Yes</span></label>
                        <label class="flex items-center cursor-pointer"><input type="radio" name="cq${i+1}" value="1" class="w-4 h-4 text-green-600"><span class="ml-2 text-sm text-green-600 font-bold">No</span></label>
                    </div>
                </div>`).join('');
            
            modalBody.innerHTML = `
                <div class="space-y-2">
                    <p class="text-xs text-gray-500 mb-4 italic text-center">Score 1 point for every "No" response. Total score out of 8.</p>
                    ${qHtml}
                    <button onclick="calculateComplianceScore()" class="w-full mt-4 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">Calculate Score</button>
                    <div id="comp-res" class="hidden"></div>
                </div>`;
        }
        modal.style.display = 'flex';
    }

    // Exported for the global scope to handle button click in modal
    window.calculateComplianceScore = function() {
        let score = 0;
        let answeredCount = 0;
        COMPLIANCE_QUESTIONS.forEach((q, i) => {
            const sel = document.querySelector(`input[name="cq${i+1}"]:checked`);
            if (sel) { score += parseInt(sel.value); answeredCount++; }
        });

        if (answeredCount < 8) {
            const res = document.getElementById('comp-res');
            res.className = "mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm font-bold text-center";
            res.textContent = "Please answer all 8 questions.";
            res.classList.remove('hidden');
            return;
        }

        let grade = '', color = '', advice = '';
        if (score >= 7) { grade = 'High Compliance'; color = 'border-green-500 text-green-600'; advice = 'Excellent adherence! Keep up the consistent medication use.'; }
        else if (score >= 5) { grade = 'Moderate Compliance'; color = 'border-yellow-500 text-yellow-600'; advice = 'Occasional lapses can increase seizure risk. Focus on improving consistency.'; }
        else { grade = 'Poor Compliance'; color = 'border-red-500 text-red-600'; advice = 'Non-adherence is dangerous. Please contact your neurologist or pharmacist immediately.'; }

        const res = document.getElementById('comp-res');
        res.className = `score-box-adherence ${color.split(' ')[0]} border-4 border-dashed bg-gray-50`;
        res.innerHTML = `
            <h4 class="text-lg font-bold text-gray-800 mb-1">Assessment Result</h4>
            <div class="text-3xl font-black ${color.split(' ')[1]} mb-2">${score} / 8</div>
            <p class="text-sm font-bold ${color.split(' ')[1]} uppercase tracking-wider mb-2">${grade}</p>
            <p class="text-xs text-gray-600 leading-relaxed">${advice}</p>
        `;
        res.classList.remove('hidden');
        res.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function closeModal(event, modalId) {
        const modalEl = document.getElementById(modalId);
        if (event.target === modalEl) modalEl.style.display = 'none';
    }

    function updateToxicityResults(val) {
        const el = document.getElementById('tox-res');
        if(!val || !ASM_ADR_TOXICITY[val]) { el.innerHTML = "Select a drug above."; return; }
        const d = ASM_ADR_TOXICITY[val];
        el.innerHTML = `<div class="text-left space-y-3"><div><span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold">ADR</span> <p class="mt-1 text-gray-800">${d.adr}</p></div><div><span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-bold">TOXICITY</span> <p class="mt-1 text-gray-800">${d.toxicity}</p></div></div>`;
    }

    function checkInteraction() {
        const asm = document.getElementById('asm1').value;
        const d2 = document.getElementById('drug2').value.trim().toUpperCase();
        const el = document.getElementById('int-res');
        if(!asm || d2.length < 3) { el.className = "p-4 bg-gray-50 rounded-lg text-sm text-gray-500 text-center"; el.innerHTML = "Select an ASM and type a second drug."; return; }
        const data = ASM_INTERACTIONS[asm];
        let hits = [];
        data.increased_by.forEach(x => { if(d2.includes(x.toUpperCase()) || x.toUpperCase().includes(d2)) hits.push({type: 'INCREASE', drug: x}); });
        data.decreased_by.forEach(x => { if(d2.includes(x.toUpperCase()) || x.toUpperCase().includes(d2)) hits.push({type: 'DECREASE', drug: x}); });
        if(hits.length === 0) {
            el.className = "p-4 bg-green-50 border border-green-200 rounded-lg text-center";
            el.innerHTML = `<p class="text-green-700 font-bold">No major interaction found</p><p class="text-xs text-green-600 mt-1">Between ${asm} and ${d2}</p>`;
        } else {
            el.className = "p-4 bg-red-50 border border-red-200 rounded-lg text-left";
            el.innerHTML = hits.map(h => `<div class="mb-2 last:mb-0"><p class="font-bold text-red-700">⚠️ INTERACTION FOUND</p><p class="text-sm text-red-600 mt-1"><strong>${h.drug}</strong> may <u>${h.type}</u> levels of ${asm}.</p></div>`).join('');
        }
    }

    function setCoreInputsDisabled(isDisabled) {
        const coreDiv = document.getElementById('calculator-core');
        if (!coreDiv) return;
        if (isDisabled) {
            coreDiv.classList.add('disabled-area');
            updateIndicationStatus(0, 'NO INDICATION (Prerequisite Failed)');
        } else {
            coreDiv.classList.remove('disabled-area');
        }
    }

    function getCalculatedBMI() {
        const weight = parseFloat(document.getElementById('input-weight').value);
        const height = parseFloat(document.getElementById('input-height').value);
        const calculatedBmiEl = document.getElementById('calculated-bmi');
        let calculatedBMI = 0;
        if (weight > 0 && height > 0) {
            calculatedBMI = weight / (height * height);
            calculatedBmiEl.textContent = calculatedBMI.toFixed(1);
        } else { calculatedBmiEl.textContent = '--'; }
        return calculatedBMI;
    }

    function handleToggleChange(id) {
        const checkbox = document.getElementById(`check-${id}`);
        if (checkbox) saveState(id, checkbox.checked);
        calculateScore();
    }
    
    function renderToggles() {
      const clinicalTogglesEl = document.getElementById('clinical-toggles');
      clinicalTogglesEl.innerHTML = '';
      CRITERIA_TOGGLES.forEach(item => {
        const key = item.id;
        const isChecked = loadState(key) === 'true';
        let linkLabel = '';
        if(item.link === 'toxicity') linkLabel = 'Check Toxicity';
        else if(item.link === 'interaction') linkLabel = 'Check Interaction';
        else if(item.link === 'compliance') linkLabel = 'Check Compliance';

        const linkButtonHtml = item.link 
            ? `<div class="mt-1 pointer-events-auto"><button class="link-button text-xs underline focus:outline-none" onclick="openModal('${item.link}')">${linkLabel} &raquo;</button></div>`
            : '';

        const html = `<div class="relative w-full bg-white border rounded-xl shadow-sm p-3"><input type="checkbox" id="check-${key}" class="toggle-checkbox" onchange="handleToggleChange('${key}')" ${isChecked ? 'checked' : ''}><label for="check-${key}" class="flex justify-between items-start w-full cursor-pointer select-none"><div class="flex-1 mr-4"><span class="text-sm font-medium text-gray-700 block">${item.text}</span><div class="relative z-20" onclick="event.stopPropagation()">${linkButtonHtml}</div></div><div class="relative w-12 h-6 rounded-full switch-bg flex-shrink-0 mt-1"><div class="absolute w-5 h-5 bg-white rounded-full shadow top-0.5 left-0.5 switch-dot"></div></div></label></div>`;
        clinicalTogglesEl.insertAdjacentHTML('beforeend', html);
      });
      ['renal', 'liver', 'pregnancy', 'surgery', 'seizure', '6months', 'dm', 'htn'].forEach(id => {
          const el = document.getElementById(`check-${id}`);
          if (el) el.checked = loadState(id) === 'true';
      });
    }

    function calculateScore() {
      const checkSeizure = document.getElementById('check-seizure');
      const check6Months = document.getElementById('check-6months');
      const prerequisiteMet = checkSeizure?.checked && check6Months?.checked;
      saveState('seizure', checkSeizure?.checked);
      saveState('6months', check6Months?.checked);
      if (!prerequisiteMet) { setCoreInputsDisabled(true); return; }
      setCoreInputsDisabled(false);
      let score = 0;
      const calculatedBMI = getCalculatedBMI();
      let bmiStatus = '';
      if (calculatedBMI > 0) {
          if (calculatedBMI >= 27.5) { score += 1; bmiStatus = 'OBESE'; document.getElementById('calculated-bmi').className = "text-3xl font-black text-red-600 mt-1"; }
          else if (calculatedBMI <= 18.5) { score += 1; bmiStatus = 'LOW BMI'; document.getElementById('calculated-bmi').className = "text-3xl font-black text-red-600 mt-1"; }
          else { bmiStatus = 'NORMAL'; document.getElementById('calculated-bmi').className = "text-3xl font-black text-green-600 mt-1"; }
      } else { bmiStatus = ''; document.getElementById('calculated-bmi').className = "text-3xl font-black text-gray-300 mt-1"; }
      document.getElementById('bmi-status').textContent = bmiStatus;
      if (document.getElementById('check-renal')?.checked) score++;
      if (document.getElementById('check-liver')?.checked) score++;
      let age = parseFloat(document.getElementById('input-age').value);
      const isChild = age > 0 && age < 20;
      const isGeriatric = age >= 65;
      const updateBox = (box, txt, met) => {
          if (met) { box.classList.remove('bg-gray-50', 'border-gray-200'); box.classList.add('bg-green-50', 'border-green-300'); txt.textContent = 'MET'; txt.classList.remove('text-gray-400'); txt.classList.add('text-green-600'); }
          else { box.classList.add('bg-gray-50', 'border-gray-200'); box.classList.remove('bg-green-50', 'border-green-300'); txt.textContent = 'NOT MET'; txt.classList.add('text-gray-400'); txt.classList.remove('text-green-600'); }
      };
      updateBox(document.getElementById('age-child-pop-box'), document.getElementById('age-child-pop-status'), isChild);
      updateBox(document.getElementById('age-geriatric-pop-box'), document.getElementById('age-geriatric-pop-status'), isGeriatric);
      if (isChild) score++;
      if (isGeriatric) score++;
      if (document.getElementById('check-pregnancy')?.checked) score++;
      if (document.getElementById('check-surgery')?.checked) score++;
      CRITERIA_TOGGLES.forEach(item => { if (document.getElementById(`check-${item.id}`)?.checked) score++; });
      updateIndicationStatus(score);
    }

    function updateIndicationStatus(score, textOverride) {
        const scoreEl = document.getElementById('final-score');
        const indicationBox = document.getElementById('indication-box');
        const indicationText = document.getElementById('indication-text');
        scoreEl.textContent = score;
        scoreEl.className = score > 0 ? "text-6xl font-black text-indigo-600 mt-1" : "text-6xl font-black text-gray-300 mt-1";
        if (textOverride) { indicationBox.className = "mt-4 p-4 rounded-xl text-center shadow-lg bg-gray-100 text-gray-400"; indicationText.textContent = textOverride; return; }
        if (score > 0) { indicationBox.className = "mt-4 p-4 rounded-xl text-center shadow-lg bg-indigo-600 text-white"; indicationText.textContent = "TDM IS INDICATED"; }
        else { indicationBox.className = "mt-4 p-4 rounded-xl text-center shadow-lg bg-gray-200 text-gray-500"; indicationText.textContent = "NO INDICATION"; }
    }

    window.onload = function() {
      renderToggles();
      ['age', 'weight', 'height'].forEach(id => {
          const el = document.getElementById(`input-${id}`);
          if (el && loadState(id)) el.value = loadState(id);
          el?.addEventListener('input', () => { saveState(id, el.value); calculateScore(); });
      });
      calculateScore();
    };

    window.handleToggleChange = handleToggleChange;
    window.calculateScore = calculateScore;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.updateToxicityResults = updateToxicityResults;
    window.checkInteraction = checkInteraction;
    window.openChatModal = openChatModal;
    window.handleChatQuery = handleChatQuery;
  </script>
</body>
</html>
